name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_call:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install ruff
        run: python -m pip install ruff
      - run: ruff format --check .
      - run: ruff check .
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - run: cargo fmt --check
      - run: cargo clippy --workspace --all-targets -- -D warnings
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - run: cargo audit

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo test --workspace --all-targets --verbose
      - run: cargo build -p vnengine_py --profile python --verbose
      - run: cargo bench -p visual_novel_engine --bench core_benches -- --warm-up-time 0.1 --measurement-time 0.1 --sample-size 10

  matrix-smoke:
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo test -p visual_novel_engine --verbose
      - run: cargo test -p vnengine_runtime --verbose

  reproducible-smoke:
    runs-on: ubuntu-latest
    needs: lint
    env:
      SOURCE_DATE_EPOCH: "1704067200"
      CARGO_PROFILE_RELEASE_DEBUG: "0"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build release artifact twice and compare hash
        shell: bash
        run: |
          set -euo pipefail
          cargo clean -p visual_novel_engine
          cargo build -p visual_novel_engine --release
          first=$(ls target/release/deps/libvisual_novel_engine-*.rlib | head -n1)
          cp "$first" /tmp/vn_first.rlib

          cargo clean -p visual_novel_engine
          cargo build -p visual_novel_engine --release
          second=$(ls target/release/deps/libvisual_novel_engine-*.rlib | head -n1)
          cp "$second" /tmp/vn_second.rlib

          sha256sum /tmp/vn_first.rlib /tmp/vn_second.rlib
          cmp --silent /tmp/vn_first.rlib /tmp/vn_second.rlib

  sbom-policy:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx --locked
      - name: Generate SBOM
        run: cargo cyclonedx --format json --all --output-file sbom.cdx.json
      - name: Validate SBOM content
        run: |
          python3 - <<'PY'
          import json
          with open("sbom.cdx.json","r",encoding="utf-8") as f:
              payload = json.load(f)
          components = payload.get("components", [])
          if not components:
              raise SystemExit("SBOM does not contain components")
          print(f"SBOM components: {len(components)}")
          PY

  fuzz-smoke:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo test -p visual_novel_engine --features arbitrary --test fuzz_tests --verbose

  python-tests:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Verify Python build artifacts
        run: |
          python3 -c 'import sysconfig; print(sysconfig.get_config_var("LIBDIR")); print(sysconfig.get_config_var("LDLIBRARY"))'
          python3 -c 'import sysconfig, pathlib; libdir=sysconfig.get_config_var("LIBDIR"); lib=sysconfig.get_config_var("LDLIBRARY"); path=pathlib.Path(libdir)/lib; print(path); assert path.exists(), f"missing {path}"'
      - name: Set Python environment for PyO3
        run: |
          echo "PYO3_PYTHON=$(which python3)" >> $GITHUB_ENV
          libdir=$(python3 -c 'import sysconfig; print(sysconfig.get_config_var("LIBDIR"))')
          echo "LD_LIBRARY_PATH=${libdir}${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}" >> $GITHUB_ENV
      - name: Create virtualenv
        run: python -m venv .venv
      - name: Install maturin in venv
        run: |
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install maturin
      - name: Build and install Python module
        run: |
          source .venv/bin/activate
          maturin develop --manifest-path crates/py/Cargo.toml
      - name: Run Python tests
        run: |
          source .venv/bin/activate
          PYTHONPATH=python python -m unittest tests.python.test_examples tests.python.test_vnengine -v
